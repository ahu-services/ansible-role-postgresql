---
- name: Validate sudo ability (debugging)
  when: postgresql_debug_sudo | default(false)
  block:
    - name: Show current user
      ansible.builtin.command: whoami
      register: postgresql_debug_whoami
      changed_when: false
    - name: Check passwordless sudo
      ansible.builtin.command: sudo -n true
      register: postgresql_debug_sudo_check
      changed_when: false
      failed_when: postgresql_debug_sudo_check.rc != 0
    - name: Inspect passwd entry for asudo
      ansible.builtin.command: sudo -n getent passwd asudo
      register: postgresql_debug_passwd
      changed_when: false
      failed_when: false
    - name: Inspect shadow entry for asudo
      ansible.builtin.command: sudo -n getent shadow asudo
      register: postgresql_debug_shadow
      changed_when: false
      failed_when: false
    - name: Show sudo diagnostics
      ansible.builtin.debug:
        msg:
          whoami: "{{ postgresql_debug_whoami.stdout }}"
          sudo_rc: "{{ postgresql_debug_sudo_check.rc }}"
          passwd: "{{ postgresql_debug_passwd.stdout | default('') }}"
          shadow: "{{ postgresql_debug_shadow.stdout | default('') }}"

- name: Install PostgreSQL Repositories
  ansible.builtin.dnf:
    name: "{{ postgresql_pgdg_repo_url }}"
    disable_gpg_check: true
  become: true

- name: Import PGDG repository GPG keys
  ansible.builtin.rpm_key:
    key: "{{ item }}"
    state: present
  loop: "{{ postgresql_pgdg_gpg_keys }}"
  become: true

- name: Disable postgresql module
  ansible.builtin.command: dnf module disable -y postgresql
  become: true
  register: result
  changed_when:
    - '"Disabling module streams" in result.stdout'

- name: Show debug pacakges
  ansible.builtin.debug:
    var: postgresql_packages

- name: Install PostgreSQL Server
  ansible.builtin.dnf:
    name: "{{ postgresql_packages }}"
  become: true
